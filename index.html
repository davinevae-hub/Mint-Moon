<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blossom Cycle</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#FF4D88">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Cute fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #FFF7FB;
      --card: rgba(255,255,255,.92);
      --pink: #FFB3C7;
      --hotpink:#FF4D88;
      --mint:#7EE7C3;
      --green:#2EB872;
      --red:#FF3B30;
      --plum:#3A1B2E;
      --muted:#7A5A6C;
      --shadow: 0 10px 30px rgba(58,27,46,.10);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 500px at 30% 0%, rgba(255,179,199,.55), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(126,231,195,.45), transparent 60%),
                  var(--bg);
      color: var(--plum);
    }

    .app{
      max-width: 1020px;
      margin: 0 auto;
      padding: 18px 16px 36px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 6px 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
    }

    .logo{
      width: 46px;
      height: 46px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--hotpink), var(--pink));
      display:grid;
      place-items:center;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), transparent 45%);
      transform: rotate(20deg);
    }
    .logo span{
      position: relative;
      font-size: 22px;
      filter: drop-shadow(0 4px 8px rgba(58,27,46,.15));
    }

    .title h1{
      font-family:"Baloo 2", cursive;
      font-size: 22px;
      line-height: 1.1;
      margin:0;
    }
    .title p{
      margin:2px 0 0;
      color: var(--muted);
      font-size: 13px;
      font-weight: 700;
    }

    .pill{
      padding: 10px 12px;
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(58,27,46,.06);
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(58,27,46,.08);
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color: var(--plum);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(58,27,46,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .card h2{
      font-family:"Baloo 2", cursive;
      margin: 0 0 10px;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .sub{
      margin: -6px 0 10px;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }

    .btn{
      border:0;
      cursor:pointer;
      padding: 12px 12px;
      border-radius: 16px;
      font-weight: 900;
      font-family: "Nunito", sans-serif;
      transition: transform .06s ease, filter .2s ease;
      display:flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .btn:active{ transform: scale(.98); }

    .btn-primary{
      background: linear-gradient(135deg, var(--hotpink), var(--pink));
      color: white;
      box-shadow: 0 10px 25px rgba(255,77,136,.25);
    }
    .btn-mint{
      background: linear-gradient(135deg, var(--green), var(--mint));
      color: #062115;
      box-shadow: 0 10px 25px rgba(46,184,114,.18);
    }
    .btn-ghost{
      background: rgba(255,255,255,.7);
      border: 1px dashed rgba(58,27,46,.18);
      color: var(--plum);
    }
    .btn-danger{
      background: linear-gradient(135deg, var(--red), #FF7A6E);
      color: #fff;
      box-shadow: 0 10px 25px rgba(255,59,48,.20);
    }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 560px){
      .kpi{ grid-template-columns: 1fr; }
    }
    .kpi .tile{
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(58,27,46,.06);
      border-radius: 18px;
      padding: 12px;
    }
    .tile .label{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
    }
    .tile .value{
      margin-top: 6px;
      font-weight: 900;
      font-size: 15px;
      line-height: 1.25;
    }

    .divider{
      height: 1px;
      background: rgba(58,27,46,.08);
      margin: 12px 0;
    }

    .calendar{
      margin-top: 10px;
    }
    .cal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .cal-head .month{
      font-family:"Baloo 2", cursive;
      font-size: 18px;
      text-align:center;
      flex: 1;
    }

    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .dow{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      text-align:center;
      padding: 6px 0;
    }
    .day{
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(58,27,46,.06);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:flex-start;
      padding: 8px;
      position: relative;
      overflow:hidden;
    }
    .day .num{
      font-weight: 900;
      font-size: 12px;
      color: rgba(58,27,46,.85);
    }
    .badge{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 900;
      padding: 6px 8px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      white-space:nowrap;
    }
    .b-period{ background: rgba(255,59,48,.14); color: #8E1410; border: 1px solid rgba(255,59,48,.25); }
    .b-pred{ background: rgba(255,77,136,.12); color: #7A0832; border: 1px solid rgba(255,77,136,.22); }
    .b-fert{ background: rgba(46,184,114,.14); color: #0A5A33; border: 1px solid rgba(46,184,114,.22); }
    .b-check{ background: rgba(255,255,255,.65); color: rgba(58,27,46,.85); border: 1px solid rgba(58,27,46,.10); }

    .tiny{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      line-height: 1.4;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .chip{
      cursor:pointer;
      border-radius: 999px;
      padding: 10px 12px;
      border: 1px solid rgba(58,27,46,.10);
      background: rgba(255,255,255,.72);
      font-weight: 900;
      user-select:none;
      display:flex;
      align-items:center;
      gap: 8px;
      transition: transform .06s ease, filter .2s ease;
    }
    .chip:active{ transform: scale(.98); }
    .chip.on{
      border-color: rgba(255,77,136,.35);
      box-shadow: 0 12px 28px rgba(255,77,136,.12);
      background: rgba(255,179,199,.18);
    }

    .inputs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 560px){
      .inputs{ grid-template-columns: 1fr; }
    }
    .field{
      background: rgba(255,255,255,.7);
      border: 1px solid rgba(58,27,46,.10);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      margin-bottom: 6px;
    }
    .field input{
      width:100%;
      font-family: "Nunito", sans-serif;
      font-weight: 900;
      font-size: 14px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(58,27,46,.12);
      outline:none;
      background: rgba(255,255,255,.88);
      color: var(--plum);
    }

    .top-guide{
      margin: 0 6px 14px;
      padding: 14px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(255,179,199,.28), rgba(126,231,195,.18));
      border: 1px solid rgba(58,27,46,.06);
      box-shadow: 0 12px 30px rgba(58,27,46,.08);
    }
    .top-guide h2{
      font-family:"Baloo 2", cursive;
      margin: 0 0 6px;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .steps{
      margin: 10px 0 0;
      padding-left: 18px;
      color: rgba(58,27,46,.92);
      font-weight: 800;
      line-height: 1.35;
      font-size: 13px;
    }
    .steps li{ margin: 6px 0; }

    .footer-note{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(58,27,46,.78);
      font-weight: 800;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.58);
      border: 1px solid rgba(58,27,46,.06);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(58,27,46,.92);
      color: #fff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,.20);
      font-weight: 900;
      opacity: 0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 9999;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- HOME ANCHOR -->
    <div id="homeTop"></div>

    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>üå∏</span></div>
        <div class="title">
          <h1>Blossom Cycle</h1>
          <p>Simple period tracking ‚Äî stays on this device</p>
        </div>
      </div>
      <div class="pill" id="todayPill">Today: ‚Äî</div>
    </header>

    <!-- TOP INSTRUCTIONS (simplified for younger teens) -->
    <section class="top-guide" aria-label="Instructions">
      <h2>‚ú® How to use this</h2>
      <div class="tiny">
        This app is for tracking your period. It‚Äôs private.
        <strong>Nothing gets shared.</strong>
      </div>

      <ol class="steps">
        <li>When your period starts, tap <strong>‚ÄúPeriod started‚Äù</strong>.</li>
        <li>When it ends, tap <strong>‚ÄúPeriod ended‚Äù</strong>.</li>
        <li>If you want, do a <strong>Daily check-in</strong> (mood + body).</li>
        <li>Tap <strong>Calendar</strong> to see the month.</li>
      </ol>

      <div class="footer-note">
        <strong>Quick note:</strong> The calendar shows ‚Äúguesses‚Äù based on averages.
        Bodies can change from stress, school, sports, sickness, or growing.
      </div>
    </section>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <h2>üå∑ Today</h2>
        <p class="sub" id="statusLine">Save your setup, then start tracking.</p>

        <div class="row">
          <button class="btn btn-primary" id="btnStart"><span>ü©∏</span>Period started</button>
          <button class="btn btn-mint" id="btnEnd"><span>‚úÖ</span>Period ended</button>
          <button class="btn btn-ghost" id="btnLog"><span>üìù</span>Daily check-in</button>
          <button class="btn btn-ghost" id="btnGoCalendar"><span>üìÖ</span>Calendar</button>
          <button class="btn btn-danger" id="btnReset"><span>üßº</span>Reset (local)</button>
        </div>

        <div class="kpi" aria-label="Helpful guesses">
          <div class="tile">
            <div class="label">NEXT PERIOD (GUESS)</div>
            <div class="value" id="kpiNext">‚Äî</div>
          </div>
          <div class="tile">
            <div class="label">GREEN DAYS (GUESS)</div>
            <div class="value" id="kpiFert">‚Äî</div>
          </div>
          <div class="tile">
            <div class="label">YOUR SETTINGS</div>
            <div class="value" id="kpiAvg">‚Äî</div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- CALENDAR ANCHOR -->
        <div id="calendarTop"></div>
        <h2>üìÖ Calendar</h2>

        <div class="cal-head">
          <button class="btn btn-ghost" id="prevMonth">‚óÄ</button>
          <div class="month" id="monthLabel">‚Äî</div>
          <button class="btn btn-ghost" id="nextMonth">‚ñ∂</button>
        </div>

        <div class="row" style="margin-bottom:10px;">
          <button class="btn btn-ghost" id="btnBackHome"><span>üè†</span>Back to Home</button>
          <button class="btn btn-ghost" id="btnPrintMonth"><span>üñ®Ô∏è</span>Print this month</button>
        </div>

        <div class="cal-grid" id="dowRow"></div>
        <div class="cal-grid calendar" id="calGrid"></div>

        <div class="footer-note">
          <strong>Important:</strong> This app helps you notice patterns. It is not birth control and not medical advice.
          If bleeding is very heavy, pain is strong, or something feels wrong, talk to a trusted adult and a clinician.
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h2>üéÄ Setup</h2>
        <p class="sub">You can change this anytime.</p>

        <div class="inputs">
          <div class="field">
            <label for="cycleLen">How many days between periods?</label>
            <input id="cycleLen" type="number" min="15" max="60" placeholder="Example: 28">
          </div>
          <div class="field">
            <label for="periodLen">How many days does your period last?</label>
            <input id="periodLen" type="number" min="1" max="12" placeholder="Example: 5">
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" id="btnSave"><span>üíæ</span>Save setup</button>
          <button class="btn btn-ghost" id="btnDemo"><span>üßÅ</span>Try demo</button>
        </div>

        <div class="divider"></div>

        <h2>üíñ Daily check-in</h2>
        <p class="tiny">Tap what fits today. You can skip anytime.</p>

        <div class="tiny" style="margin:10px 0 6px;">Mood</div>
        <div class="chips" id="moodChips"></div>

        <div class="tiny" style="margin:12px 0 6px;">Body</div>
        <div class="chips" id="symptomChips"></div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-mint" id="btnSaveCheckin"><span>üåü</span>Save check-in</button>
          <button class="btn btn-ghost" id="btnClearCheckin"><span>ü´ß</span>Clear</button>
        </div>

        <div class="divider"></div>

        <h2>üì≤ Add to Home Screen</h2>
        <p class="tiny" id="installHelp">
          iPhone: open in Safari ‚Üí Share ‚Üí ‚ÄúAdd to Home Screen‚Äù.<br>
          Android: Chrome ‚Üí Menu (‚ãÆ) ‚Üí ‚ÄúAdd to Home Screen‚Äù.
        </p>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" id="btnInstall" style="display:none;"><span>‚¨áÔ∏è</span>Install app</button>
        </div>

        <div class="divider"></div>

        <h2>üîí Privacy</h2>
        <p class="tiny">
          This app saves your info only on this device (local storage). No accounts. No cloud. No sharing.
        </p>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast">Saved!</div>

<script>
  // -----------------------------
  // PWA: Register Service Worker
  // -----------------------------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try { await navigator.serviceWorker.register("./sw.js"); }
      catch (e) { /* silent */ }
    });
  }

  // -----------------------------
  // PWA: Install prompt (mainly Android/Chrome)
  // -----------------------------
  let deferredPrompt = null;
  const btnInstall = document.getElementById("btnInstall");
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btnInstall.style.display = "inline-flex";
  });

  btnInstall.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btnInstall.style.display = "none";
  });

  // iOS Safari hint
  (function(){
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isSafari = isIOS && /safari/i.test(navigator.userAgent) && !/crios|fxios|opios/i.test(navigator.userAgent);
    const help = document.getElementById("installHelp");
    if (isIOS && !isSafari) {
      help.textContent = "On iPhone, open this in Safari, then Share ‚Üí Add to Home Screen.";
    }
  })();

  // -----------------------------
  // Data model (local-only)
  // -----------------------------
  const STORAGE_KEY = "blossom_cycle_v3";

  const defaultState = () => ({
    settings: { avgCycleLen: 28, avgPeriodLen: 5 },
    periods: [],
    checkins: {} // "YYYY-MM-DD": { mood:[], symptoms:[] }
  });

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    try{
      const parsed = JSON.parse(raw);
      return { ...defaultState(), ...parsed };
    }catch{
      return defaultState();
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // -----------------------------
  // Utilities
  // -----------------------------
  const pad = (n) => String(n).padStart(2, "0");
  function toISODate(d){
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function fromISODate(s){
    const [y,m,dd] = s.split("-").map(Number);
    return new Date(y, m-1, dd);
  }
  function addDays(date, days){
    const d = new Date(date);
    d.setDate(d.getDate() + days);
    return d;
  }
  function fmtShort(iso){
    if(!iso) return "‚Äî";
    const d = fromISODate(iso);
    return d.toLocaleDateString(undefined, { month:"short", day:"numeric" });
  }
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }
  function safeNum(v){ return Number.isFinite(Number(v)) ? Number(v) : null; }

  // -----------------------------
  // Prediction logic (simple averages)
  // -----------------------------
  function getLastPeriod(){
    if(!state.periods.length) return null;
    const sorted = [...state.periods].sort((a,b)=>a.start.localeCompare(b.start));
    return sorted[sorted.length - 1];
  }

  function estimateNextPeriodStart(){
    const last = getLastPeriod();
    if(!last) return null;
    const start = fromISODate(last.start);
    const next = addDays(start, Number(state.settings.avgCycleLen || 28));
    return toISODate(next);
  }

  function estimateNextPeriodWindow(){
    const nextStart = estimateNextPeriodStart();
    if(!nextStart) return null;
    const s = fromISODate(nextStart);
    const len = Number(state.settings.avgPeriodLen || 5);
    const e = addDays(s, Math.max(len-1, 0));
    return { start: toISODate(s), end: toISODate(e) };
  }

  function estimateGreenDays(){
    // Teen-friendly: ‚ÄúGreen days‚Äù are a guess of days your body *might* be more active.
    const nextStart = estimateNextPeriodStart();
    if(!nextStart) return null;
    const next = fromISODate(nextStart);
    const mid = addDays(next, -14);
    const start = addDays(mid, -5);
    const end = mid;
    return { start: toISODate(start), end: toISODate(end) };
  }

  function isDateInRange(iso, range){
    if(!range) return false;
    return iso >= range.start && iso <= range.end;
  }

  function getPeriodDatesSet(){
    const set = new Set();
    for(const p of state.periods){
      if(!p.start) continue;
      const start = fromISODate(p.start);
      const end = p.end ? fromISODate(p.end) : start;
      let cur = new Date(start);
      while(cur <= end){
        set.add(toISODate(cur));
        cur = addDays(cur, 1);
      }
    }
    return set;
  }

  // -----------------------------
  // UI state
  // -----------------------------
  const today = new Date();
  const todayISO = toISODate(today);

  function refreshHeader(){
    document.getElementById("todayPill").textContent =
      `Today: ${today.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" })}`;

    const last = getLastPeriod();
    let status = "You can tap Daily check-in if you want. (It‚Äôs optional.)";
    if(last?.start && !last.end){
      status = `Period is happening now (started ${fmtShort(last.start)}).`;
    } else if(last?.end){
      status = `Last period ended ${fmtShort(last.end)}.`;
    } else if(!state.periods.length){
      status = "When your period starts, tap ‚ÄúPeriod started‚Äù.";
    }
    document.getElementById("statusLine").textContent = status;

    const next = estimateNextPeriodStart();
    const green = estimateGreenDays();

    document.getElementById("kpiNext").textContent = next ? fmtShort(next) : "‚Äî";
    document.getElementById("kpiFert").textContent = green ? `${fmtShort(green.start)}‚Äì${fmtShort(green.end)}` : "‚Äî";
    document.getElementById("kpiAvg").textContent =
      `${state.settings.avgCycleLen} days ‚Ä¢ period ~ ${state.settings.avgPeriodLen} days`;
  }

  // -----------------------------
  // Setup
  // -----------------------------
  function bindSetup(){
    const cycle = document.getElementById("cycleLen");
    const period = document.getElementById("periodLen");
    cycle.value = state.settings.avgCycleLen;
    period.value = state.settings.avgPeriodLen;

    document.getElementById("btnSave").addEventListener("click", ()=>{
      const c = safeNum(cycle.value);
      const p = safeNum(period.value);

      if(c === null || c < 15 || c > 60){
        toast("Try a number like 21‚Äì35.");
        return;
      }
      if(p === null || p < 1 || p > 12){
        toast("Try a number like 3‚Äì7.");
        return;
      }

      state.settings.avgCycleLen = c;
      state.settings.avgPeriodLen = p;
      saveState();
      toast("Setup saved!");
      refreshAll();
    });

    document.getElementById("btnDemo").addEventListener("click", ()=>{
      const t = new Date();
      const p1s = toISODate(addDays(t, -55));
      const p1e = toISODate(addDays(t, -51));
      const p2s = toISODate(addDays(t, -27));
      const p2e = toISODate(addDays(t, -23));

      state.settings.avgCycleLen = 28;
      state.settings.avgPeriodLen = 5;
      state.periods = [
        { start: p1s, end: p1e },
        { start: p2s, end: p2e }
      ];
      state.checkins = {};
      saveState();
      toast("Demo loaded!");
      refreshAll();
    });
  }

  // -----------------------------
  // Period logging
  // -----------------------------
  function startPeriod(){
    const last = getLastPeriod();
    if(last && !last.end){
      toast("You already started it.");
      return;
    }
    state.periods.push({ start: todayISO, end: null });
    saveState();
    toast("Saved: period started!");
    refreshAll();
  }

  function endPeriod(){
    const last = getLastPeriod();
    if(!last || last.end){
      toast("No period to end.");
      return;
    }
    last.end = todayISO;
    saveState();
    toast("Saved: period ended!");
    refreshAll();
  }

  // -----------------------------
  // Check-in chips
  // -----------------------------
  const moods = [
    { key:"happy", label:"üòä Happy" },
    { key:"okay", label:"üôÇ Okay" },
    { key:"tired", label:"ü•± Tired" },
    { key:"stressed", label:"üòµ‚Äçüí´ Stressed" },
    { key:"sad", label:"üòî Sad" },
    { key:"confident", label:"üòå Confident" },
    { key:"grumpy", label:"üò§ Grumpy" }
  ];

  const symptoms = [
    { key:"cramps", label:"üî• Cramps" },
    { key:"headache", label:"ü§ï Headache" },
    { key:"bloating", label:"üéà Bloated" },
    { key:"acne", label:"üåô Acne" },
    { key:"tender", label:"üíó Tender chest" },
    { key:"nausea", label:"ü§¢ Nausea" },
    { key:"back", label:"üßç Back hurt" },
    { key:"sleepy", label:"üõå Sleepy" }
  ];

  let selectedMood = new Set();
  let selectedSymptoms = new Set();

  function renderChips(containerId, items, selectedSet){
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    items.forEach(item=>{
      const c = document.createElement("div");
      c.className = "chip" + (selectedSet.has(item.key) ? " on" : "");
      c.textContent = item.label;
      c.addEventListener("click", ()=>{
        if(selectedSet.has(item.key)) selectedSet.delete(item.key);
        else selectedSet.add(item.key);
        renderChips(containerId, items, selectedSet);
      });
      el.appendChild(c);
    });
  }

  function loadCheckinForToday(){
    const existing = state.checkins[todayISO];
    selectedMood = new Set(existing?.mood || []);
    selectedSymptoms = new Set(existing?.symptoms || []);
    renderChips("moodChips", moods, selectedMood);
    renderChips("symptomChips", symptoms, selectedSymptoms);
  }

  function saveCheckin(){
    state.checkins[todayISO] = {
      mood: [...selectedMood],
      symptoms: [...selectedSymptoms]
    };
    saveState();
    toast("Check-in saved!");
    refreshAll();
  }

  function clearCheckin(){
    selectedMood.clear();
    selectedSymptoms.clear();
    renderChips("moodChips", moods, selectedMood);
    renderChips("symptomChips", symptoms, selectedSymptoms);
    toast("Cleared!");
  }

  // -----------------------------
  // Calendar rendering
  // -----------------------------
  let viewYear = today.getFullYear();
  let viewMonth = today.getMonth(); // 0-based

  const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  function renderDows(){
    const row = document.getElementById("dowRow");
    row.innerHTML = "";
    dows.forEach(d=>{
      const div = document.createElement("div");
      div.className = "dow";
      div.textContent = d;
      row.appendChild(div);
    });
  }

  function renderCalendar(){
    const label = document.getElementById("monthLabel");
    const first = new Date(viewYear, viewMonth, 1);
    label.textContent = first.toLocaleDateString(undefined, { month:"long", year:"numeric" });

    const grid = document.getElementById("calGrid");
    grid.innerHTML = "";

    const startDow = first.getDay();
    const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();

    const periodSet = getPeriodDatesSet();
    const predPeriod = estimateNextPeriodWindow();
    const green = estimateGreenDays();

    for(let i=0;i<startDow;i++){
      const blank = document.createElement("div");
      blank.className = "day";
      blank.style.opacity = "0";
      grid.appendChild(blank);
    }

    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(viewYear, viewMonth, day);
      const iso = toISODate(d);

      const cell = document.createElement("div");
      cell.className = "day";

      const num = document.createElement("div");
      num.className = "num";
      num.textContent = day;
      cell.appendChild(num);

      if(periodSet.has(iso)){
        const b = document.createElement("div");
        b.className = "badge b-period";
        b.textContent = "ü©∏ Period";
        cell.appendChild(b);
      } else if(isDateInRange(iso, predPeriod)){
        const b = document.createElement("div");
        b.className = "badge b-pred";
        b.textContent = "üéÄ Guess";
        cell.appendChild(b);
      } else if(isDateInRange(iso, green)){
        const b = document.createElement("div");
        b.className = "badge b-fert";
        b.textContent = "üåø Green";
        cell.appendChild(b);
      }

      const ci = state.checkins[iso];
      if(ci && (ci.mood?.length || ci.symptoms?.length)){
        const b = document.createElement("div");
        b.className = "badge b-check";
        b.textContent = "‚≠ê Check";
        cell.appendChild(b);
      }

      grid.appendChild(cell);
    }
  }

  // -----------------------------
  // Print month (opens a printable page)
  // -----------------------------
  function escapeHTML(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function buildMonthPrintHTML(year, month){
    const first = new Date(year, month, 1);
    const monthName = first.toLocaleDateString(undefined, { month:"long", year:"numeric" });
    const startDow = first.getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();

    const periodSet = getPeriodDatesSet();
    const predPeriod = estimateNextPeriodWindow();
    const green = estimateGreenDays();

    let cells = "";

    for(let i=0;i<startDow;i++){
      cells += `<div class="cell blank"></div>`;
    }

    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(year, month, day);
      const iso = toISODate(d);

      const tags = [];
      if(periodSet.has(iso)) tags.push(`<span class="tag period">ü©∏ Period</span>`);
      if(!periodSet.has(iso) && isDateInRange(iso, predPeriod)) tags.push(`<span class="tag guess">üéÄ Guess</span>`);
      if(!periodSet.has(iso) && isDateInRange(iso, green)) tags.push(`<span class="tag green">üåø Green</span>`);

      const ci = state.checkins[iso];
      let details = "";
      if(ci && (ci.mood?.length || ci.symptoms?.length)){
        tags.push(`<span class="tag check">‚≠ê Check-in</span>`);
        const moodText = (ci.mood || []).map(k => (moods.find(m=>m.key===k)?.label || k)).join(", ");
        const symText  = (ci.symptoms || []).map(k => (symptoms.find(s=>s.key===k)?.label || k)).join(", ");
        const lines = [];
        if(moodText) lines.push(`<div class="small"><strong>Mood:</strong> ${escapeHTML(moodText)}</div>`);
        if(symText)  lines.push(`<div class="small"><strong>Body:</strong> ${escapeHTML(symText)}</div>`);
        if(lines.length) details = `<div class="details">${lines.join("")}</div>`;
      }

      cells += `
        <div class="cell">
          <div class="num">${day}</div>
          <div class="tags">${tags.join("")}</div>
          ${details}
        </div>
      `;
    }

    return `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${monthName} ‚Ä¢ Blossom Cycle</title>
  <style>
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; color:#3A1B2E; }
    h1{ margin: 0 0 6px; }
    .note{ margin: 0 0 14px; color:#7A5A6C; font-weight:600; }
    .grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .dow{ font-weight:800; text-align:center; color:#7A5A6C; }
    .cell{ border: 1px solid rgba(58,27,46,.12); border-radius: 14px; padding: 10px; min-height: 90px; }
    .blank{ border: none; }
    .num{ font-weight:900; margin-bottom: 6px; }
    .tags{ display:flex; flex-wrap:wrap; gap: 6px; margin-bottom: 6px; }
    .tag{ font-size: 12px; font-weight:800; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(58,27,46,.12); background: rgba(255,255,255,.7); }
    .period{ background: rgba(255,59,48,.14); border-color: rgba(255,59,48,.22); color:#8E1410; }
    .guess{ background: rgba(255,77,136,.12); border-color: rgba(255,77,136,.22); color:#7A0832; }
    .green{ background: rgba(46,184,114,.14); border-color: rgba(46,184,114,.22); color:#0A5A33; }
    .check{ background: rgba(58,27,46,.06); }
    .details{ margin-top: 6px; }
    .small{ font-size: 12px; color:#3A1B2E; margin: 2px 0; }
    .footer{ margin-top: 14px; font-size: 12px; color:#7A5A6C; font-weight:600; }
    @media print{
      body{ margin: 0.4in; }
      .cell{ break-inside: avoid; }
    }
  </style>
</head>
<body>
  <h1>${monthName}</h1>
  <p class="note">Monthly calendar from Blossom Cycle. You can print this page to save as a PDF.</p>

  <div class="grid">
    <div class="dow">Sun</div><div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div><div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div>
    ${cells}
  </div>

  <div class="footer">
    ‚ÄúGuess‚Äù and ‚ÄúGreen‚Äù days are estimates based on averages. Bodies can change.
  </div>
</body>
</html>`;
  }

  function printThisMonth(){
    const html = buildMonthPrintHTML(viewYear, viewMonth);
    const w = window.open("", "_blank");
    if(!w){ toast("Pop-up blocked. Try again or allow pop-ups."); return; }
    w.document.open();
    w.document.write(html);
    w.document.close();
    w.focus();
    setTimeout(()=>w.print(), 450);
  }

  // -----------------------------
  // Navigation helpers
  // -----------------------------
  function goHome(){
    document.getElementById("homeTop").scrollIntoView({ behavior:"smooth", block:"start" });
  }
  function goCalendar(){
    document.getElementById("calendarTop").scrollIntoView({ behavior:"smooth", block:"start" });
  }
  function goCheckin(){
    document.querySelector("aside.card").scrollIntoView({ behavior:"smooth", block:"start" });
  }

  // -----------------------------
  // Buttons
  // -----------------------------
  function bindActions(){
    document.getElementById("btnStart").addEventListener("click", startPeriod);
    document.getElementById("btnEnd").addEventListener("click", endPeriod);

    document.getElementById("btnLog").addEventListener("click", ()=>{
      goCheckin();
      toast("Check-in is on the right!");
    });

    document.getElementById("btnGoCalendar").addEventListener("click", ()=>{
      goCalendar();
      toast("Calendar!");
    });

    document.getElementById("btnBackHome").addEventListener("click", ()=>{
      goHome();
      toast("Back to home!");
    });

    document.getElementById("btnSaveCheckin").addEventListener("click", saveCheckin);
    document.getElementById("btnClearCheckin").addEventListener("click", clearCheckin);

    document.getElementById("prevMonth").addEventListener("click", ()=>{
      viewMonth--;
      if(viewMonth < 0){ viewMonth = 11; viewYear--; }
      renderCalendar();
    });

    document.getElementById("nextMonth").addEventListener("click", ()=>{
      viewMonth++;
      if(viewMonth > 11){ viewMonth = 0; viewYear++; }
      renderCalendar();
    });

    document.getElementById("btnPrintMonth").addEventListener("click", printThisMonth);

    document.getElementById("btnReset").addEventListener("click", ()=>{
      localStorage.removeItem(STORAGE_KEY);
      state = defaultState();
      toast("Reset done (only on this device).");
      refreshAll();
      goHome();
    });
  }

  // -----------------------------
  // Refresh
  // -----------------------------
  function refreshAll(){
    refreshHeader();
    renderDows();
    renderCalendar();

    document.getElementById("cycleLen").value = state.settings.avgCycleLen;
    document.getElementById("periodLen").value = state.settings.avgPeriodLen;
    loadCheckinForToday();
  }

  // Init
  bindSetup();
  bindActions();
  refreshAll();
</script>
</body>
</html>
